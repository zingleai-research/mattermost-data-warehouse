{
  "model": {
    "name": "fct_active_users",
    "columns": [
      {
        "name": "server_id",
        "type": "VARCHAR",
        "description": "Server identifier (excludable servers filtered out)"
      },
      {
        "name": "daily_active_users",
        "type": "BIGINT",
        "description": "Daily active users (servers with 0 users filtered out)"
      }
    ]
  },
  "business_context": "This PR changes the business logic of fct_active_users to filter out excludable servers (test servers, internal servers, invalid data) at the fact table level. Previously, this filtering only happened in downstream reports. The change also switches from FULL OUTER JOIN to LEFT JOIN and adds a minimum threshold for active users. This improves data quality but may reduce the number of rows and affect historical trend analysis.",
  "test_cases": [
    {
      "category": "Data Quality",
      "name": "Excludable Servers Are Filtered Out",
      "description": "Validate that no excludable servers appear in fct_active_users results",
      "why_required": "Excludable servers (test, internal, invalid) should be excluded from analytics. If they appear in results, data quality is compromised.",
      "what_was_missed": "No validation that excludable servers are properly filtered",
      "target": "fct_active_users",
      "test_query": "SELECT COUNT(*) FROM {{ ref('fct_active_users') }} fau INNER JOIN {{ ref('dim_excludable_servers') }} ex ON fau.server_id = ex.server_id",
      "details": {
        "why_required": "Excludable servers (test, internal, invalid) should be excluded from analytics. If they appear in results, data quality is compromised.",
        "what_was_missed": "No validation that excludable servers are properly filtered",
        "rationale": "Ensures data quality by excluding invalid servers",
        "gap": "Missing validation that filtering logic works correctly"
      }
    },
    {
      "category": "Business Logic",
      "name": "Minimum Active Users Threshold Validation",
      "description": "Validate that all rows have daily_active_users > 0",
      "why_required": "The new business logic requires minimum 1 active user. Servers with 0 active users should be excluded. Need to verify this filter works correctly.",
      "what_was_missed": "No validation that minimum threshold filter is applied",
      "target": "fct_active_users",
      "test_query": "SELECT COUNT(*) FROM {{ ref('fct_active_users') }} WHERE daily_active_users <= 0",
      "details": {
        "why_required": "The new business logic requires minimum 1 active user. Servers with 0 active users should be excluded. Need to verify this filter works correctly.",
        "what_was_missed": "No validation that minimum threshold filter is applied",
        "rationale": "Ensures minimum threshold business rule is enforced",
        "gap": "Missing validation for minimum threshold filter"
      }
    },
    {
      "category": "Data Quality",
      "name": "Row Count Impact Analysis",
      "description": "Compare row counts before and after business logic changes to understand data reduction impact",
      "why_required": "Filtering out excludable servers and zero-user servers will reduce row count. Need to quantify the impact to ensure it's acceptable and doesn't break downstream reports.",
      "what_was_missed": "No analysis of how many rows will be excluded by the new filters",
      "target": "fct_active_users",
      "test_query": "-- Compare row counts:\n-- Before: SELECT COUNT(*) FROM old_fct_active_users\n-- After: SELECT COUNT(*) FROM {{ ref('fct_active_users') }}\n-- Expected: Reduction of 5-15% depending on excludable server count",
      "details": {
        "why_required": "Filtering out excludable servers and zero-user servers will reduce row count. Need to quantify the impact to ensure it's acceptable and doesn't break downstream reports.",
        "what_was_missed": "No analysis of how many rows will be excluded by the new filters",
        "rationale": "Understanding row count impact helps assess downstream report impact",
        "gap": "Missing impact analysis for data volume changes"
      }
    },
    {
      "category": "Business Logic",
      "name": "LEFT JOIN vs FULL OUTER JOIN Impact",
      "description": "Validate that servers without telemetry data are excluded (due to LEFT JOIN change)",
      "why_required": "Changing from FULL OUTER JOIN to LEFT JOIN means servers without user telemetry are excluded. Need to verify this is the intended behavior and doesn't break downstream reports.",
      "what_was_missed": "No validation of join type change impact",
      "target": "fct_active_users",
      "test_query": "SELECT COUNT(*) FROM {{ ref('int_server_active_days_spined') }} sas LEFT JOIN {{ ref('int_user_active_days_spined') }} uad ON sas.daily_server_id = uad.daily_server_id WHERE uad.server_id IS NULL AND sas.server_id NOT IN (SELECT server_id FROM {{ ref('dim_excludable_servers') }})",
      "details": {
        "why_required": "Changing from FULL OUTER JOIN to LEFT JOIN means servers without user telemetry are excluded. Need to verify this is the intended behavior and doesn't break downstream reports.",
        "what_was_missed": "No validation of join type change impact",
        "rationale": "Ensures join type change doesn't unintentionally exclude valid servers",
        "gap": "Missing validation for join strategy change"
      }
    }
  ]
}

